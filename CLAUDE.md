# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

DabTimer is a Capacitor-based mobile application (primarily Android) that provides precision timing for dabbing sessions. The app calculates optimal heat-up and cool-down times based on scientific formulas considering material properties (Quartz/Titanium/Ceramic), concentrate types (Shatter/Wax/Resin/etc.), and heating methods (Butane/Propane).

**Core Architecture**: Capacitor 6.1.2 wraps a vanilla JavaScript/HTML/CSS web application into a native Android APK.

## Development Commands

### Installation & Setup
```bash
npm install              # Install dependencies
npm run sync            # Sync Capacitor Android platform
```

### Building

**Debug APK** (most common for testing):
```bash
cd android
./gradlew assembleDebug
# Output: android/app/build/outputs/apk/debug/app-debug.apk
```

**Release APK** (requires keystore configuration):
```bash
cd android
./gradlew assembleRelease
# Output: android/app/build/outputs/apk/release/app-release.apk
```

**NPM shortcuts**:
```bash
npm run build           # Sync Capacitor
npm run android:build   # Build debug APK
npm run android:release # Build release APK
```

### Development Workflow
1. Edit files in `www/` directory (HTML/CSS/JS)
2. Run `npm run sync` to copy changes to Android platform
3. Build APK with Gradle commands above
4. Install APK on device/emulator for testing

## Project Structure & Architecture

```
DabTimer/
├── www/                           # Web application (source of truth)
│   ├── index.html                # Single-page app with inline styles
│   ├── js/
│   │   ├── app.js                # Core application logic (MAIN FILE)
│   │   ├── calendar-core.js      # Session tracking & analytics
│   │   ├── calendar-charts.js    # Chart.js integration for data viz
│   │   └── [other js files]      # Legacy/backup files (mostly unused)
│   ├── css/
│   │   ├── style.css             # Main stylesheet (dark themes)
│   │   ├── completion-animations.css
│   │   └── calendar-redesign.css
│   └── images/                   # Concentrate images, icons
│
├── android/                      # Native Android project (generated by Capacitor)
│   ├── app/build.gradle          # App-level config (signing, versions)
│   ├── build.gradle              # Project-level Gradle config
│   └── variables.gradle          # SDK versions (minSdk=22, target=34)
│
├── DabTimerAndroid/              # Legacy Cordova version (not actively used)
│   └── www/                      # Old implementation
│
├── capacitor.config.json         # Capacitor configuration
├── package.json                  # Dependencies & npm scripts
├── README.md                     # User-facing documentation
└── DabTimer_PRD.md               # Product Requirements Document
```

### Key Architecture Patterns

**State Management**: Single global `state` object in `app.js` containing:
- `settings`: User preferences (material, concentrate, heater, theme, custom timers)
- `timer`: Timer state (isRunning, mode, timeLeft, totalTime, interval)

**Data Storage**:
- All data persists in browser `localStorage`
- Settings: `dt_settings`, `dt_customTimes`, `dt_theme`
- Session history: `dt_sessions` (array of timestamped dab records)
- Age verification: `ageVerified`, `userState`

**Timer Calculation Formula**:
```javascript
// Located in CONFIG object in app.js
heatTime = material.heatUp × heater.heatModifier
coolTime = material.coolDown × heater.coolModifier × concentrate.coolModifier
```

**Tab Navigation**: Four screens (Home, Timer, Calendar, Settings) managed by showing/hiding `.screen` divs. Active tab state managed via `active` class on nav buttons.

**Theme System**: 12 color themes dynamically applied via CSS custom properties. Theme selection modifies root-level CSS variables for gradients, accents, and backgrounds.

## Critical Implementation Details

### Timer Lifecycle
1. User selects material/concentrate/heater on Home screen
2. Clicking "Start Timer" calculates heat/cool times and navigates to Timer screen
3. Timer runs two phases: HEAT UP → COOL DOWN
4. Completion triggers animation and logs session to calendar
5. Session data: `{ timestamp, material, concentrate, heater, heatTime, coolTime }`

### Calendar/Analytics System
- `calendar-core.js`: Data retrieval, filtering, stats calculation
- `calendar-charts.js`: Chart.js rendering (activity, concentrate preferences, peak hours)
- Charts update dynamically based on time range selection (week/month/year)
- Quick stats: total sessions, daily count, streak tracking

### Age Verification Flow
- First app launch shows age verification screen (`#age-verification`)
- Requires US state selection + birthdate validation (21+ only)
- Sets `localStorage.ageVerified = 'true'` to bypass on future launches
- Mock session data is created immediately after verification

### Build System Notes
- **Gradle**: v8.7.2, requires JDK 17
- **Android SDK**: compileSdk 34, minSdk 22, targetSdk 34
- **Signing**: Conditional release signing via `release-keystore.jks` + environment variables
- **Capacitor sync**: Copies `www/` → `android/app/src/main/assets/public/`

## CI/CD (GitHub Actions)

**Two workflow files exist**:
1. `.github/workflows/android.yml` - Main workflow (comprehensive)
2. `.github/workflows/build.yml` - Alternative workflow (simpler)

**Primary workflow**: `.github/workflows/android.yml`

**Triggers**: Push to main/develop, pull requests, manual workflow_dispatch
**Jobs**:
1. `build-debug`: Builds unsigned debug APK on every push
2. `build-release`: Builds signed release APK/AAB (main branch only, requires secrets)

**Required secrets for signed releases**:
- `ANDROID_KEYSTORE_BASE64`: Base64-encoded keystore file
- `ANDROID_KEYSTORE_PASSWORD`, `ANDROID_KEY_ALIAS`, `ANDROID_KEY_PASSWORD`

**Recent CI/CD improvements** (from PR history):
- Fixed package.json dependencies and updated GitHub Actions to latest versions (PR #11)
- Refactored Android CI workflow for APK build (PR #9)
- Multiple iterations to fix build issues and improve workflow reliability

## Common Development Scenarios

### Adding a New Concentrate Type
1. Update `CONFIG.concentrates` object in `app.js` with coolModifier
2. Add image to `www/images/`
3. Update UI in `index.html` to include new option button
4. Update `setupOptionButtons()` to handle selection

### Modifying Timer Calculations
- Edit `CONFIG.materials`, `CONFIG.heaters`, or `CONFIG.concentrates` in `app.js`
- Changes apply immediately to next timer start
- Custom timer override in Settings takes precedence

### Theme Development
- Themes defined via CSS custom properties in `index.html` `<style>` block
- Theme switch handled by `applyTheme(themeName)` function in `app.js`
- New themes: add color definitions and update theme button grid in Settings

### Debugging Calendar Issues
- Check browser console for `Calendar` object logs
- Verify `localStorage.getItem('dt_sessions')` contains valid JSON array
- Session format: `{ timestamp: Date.toISOString(), material, concentrate, heater, heatTime, coolTime }`

## Technology Stack

- **Framework**: Capacitor 6.1.2 (web → native bridge)
- **UI**: Vanilla JavaScript (no framework), HTML5, CSS3
- **Charts**: Chart.js (CDN)
- **Icons**: Font Awesome 6.4.0 (CDN)
- **Fonts**: Montserrat (Google Fonts)
- **Build**: Gradle 8.7.2, Android SDK 34, JDK 17
- **CI**: GitHub Actions (Node 20, Ubuntu latest)

## Important Files

- **`www/js/app.js`** - Main application logic, state management, timer calculations, UI initialization
- **`www/index.html`** - Complete UI structure with embedded styles (single-page app)
- **`www/js/calendar-core.js`** - Session data management, analytics calculations
- **`www/js/calendar-charts.js`** - Chart rendering and data visualization
- **`android/app/build.gradle`** - Android app configuration, signing setup
- **`capacitor.config.json`** - App ID, name, web directory mapping
- **`.github/workflows/android.yml`** - CI/CD pipeline definition

## Code Style Notes

- Uses ES6+ JavaScript (const/let, arrow functions, template literals)
- localStorage keys prefixed with `dt_` (DabTimer)
- Console logging for debugging (production builds should strip these)
- Dark theme optimized UI (background: #0a0a0a base)
- Mobile-first, portrait-optimized layout

## Development History & Context

**Repository**: https://github.com/twoskoops707/DabTimer
**Primary Contributors**: twoskoops707, jsmil, GitHub Copilot
**Recent Development Focus** (last 7 days):
- UI enhancements with glass morphism, animations, accessibility improvements (PR #8)
- Multiple iterations on index.html, app.js, and style.css
- Image asset management (concentrate images moved to correct location)
- Sample data generation for calendar/analytics testing

**Key Milestones**:
- Initial UI modernization and settings refactor (PR #1)
- Build system stabilization and CI/CD setup
- Addition of 12 color themes (expanded from original 6)
- Calendar analytics with Chart.js integration
- Age verification system implementation

**Legacy Code**:
- `DabTimerAndroid/` folder contains old Cordova-based implementation
- Many `.js.backup`, `.js.bak`, and alternative implementation files exist in `www/js/` - these are not actively used
- Main application logic consolidated into `www/js/app.js`

**Testing & Distribution**:
- Debug APKs available as GitHub Actions artifacts (30-day retention)
- Release APKs/AABs available when keystore configured (90-day retention)
- No current Play Store deployment (manual APK distribution)
